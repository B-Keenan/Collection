---
- name: Testing pre & post upgrade checks
  hosts: bigips_test
  gather_facts: False
  vars:

    provider:
      password: "{{ ansible_ssh_pass }}"
      server: "{{ ansible_host }}"
      user: "sd-0482"
      validate_certs: False
  
  tasks:
    - name: Get Information
      bigip_device_info:
        gather_subset:
          - virtual-servers
          - ltm-pools
          - self-ips
        provider: "{{ provider }}"
      register: f5_info

    - name: Pre-Upgrade Parse
      set_fact:
        startvirtstats: "{{ f5_info.virtual_servers
          | items2dict(key_name='name', value_name='availability_status') }}"
        startpoolstats: "{{ f5_info.ltm_pools
          | items2dict(key_name='name', value_name='availability_status') }}"
        startselfstats: "{{ f5_info.self_ips
          | items2dict(key_name='name', value_name='vlan') }}"
      #when: stage == "pre"

    - name: Post Upgrade Checks
      block:
        - name: Post-Upgrade Parse
          set_fact:
            endvirtstats: "{{ f5_info.virtual_servers
              | items2dict(key_name='name', value_name='availability_status') }}"
            endpoolstats: "{{ f5_info.ltm_pools
              | items2dict(key_name='name', value_name='availability_status') }}"
            endselfstats: "{{ f5_info.self_ips
              | items2dict(key_name='name', value_name='vlan') }}"

        - name: Check Virtual Servers
          assert:
            that:
              - item.value == endvirtstats[item.key]
            fail_msg: "Virtual server '{{ item.key }}' state changed from '{{ item.value }}' to '{{ endvirtstats[item.key] }}'"
            success_msg: "{{ item.key }} state unchanged"
            quiet: yes
          loop: "{{ startvirtstats|dict2items }}"
          loop_control:
            label: "{{ item.key }}"
          any_errors_fatal: true
          #when: check_virts

        - name: Check Pools
          assert:
            that:
              - item.value == endpoolstats[item.key]
            fail_msg: "Pool '{{ item.key }}' state changed from '{{ item.value }}' to '{{ endpoolstats[item.key] }}'"
            success_msg: "{{ item.key }} state unchanged"
            quiet: yes
          loop: "{{ startpoolstats|dict2items }}"
          loop_control:
            label: "{{ item.key }}"
          any_errors_fatal: true
          #when: check_pools

        - name: Check Self-IPs
          assert:
            that:
              - item.value == endselfstats[item.key]
            fail_msg: "Self-IP '{{ item.key }}' state changed from '{{ item.value }}' to '{{ endselfstats[item.key] }}'"
            success_msg: "{{ item.key }} state unchanged"
            quiet: yes
          loop: "{{ startpoolstats|dict2items }}"
          loop_control:
            label: "{{ item.key }}"
          any_errors_fatal: true
          #when: check_self

      #when: stage == "post"